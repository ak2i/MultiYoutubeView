<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Multi YouTube Live Viewer (Thumbs Only)</title>
  <style>
    :root{
      --gap: 10px;
      --thumb-min: 220px;
      --bg: #111;
      --panel: #0b0b0b;
      --border: #222;
      --text: #eee;
      --muted: #aaa;
    }
    body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",sans-serif; background:var(--bg); color:var(--text); }
    header{
      position: sticky; top:0; z-index:10;
      background:#161616; border-bottom:1px solid #2a2a2a;
      padding:10px;
    }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input, button, select{
      background:#0f0f0f; color:var(--text);
      border:1px solid #333; border-radius:10px;
      padding:10px;
    }
    input{ min-width:min(560px, 92vw); }
    button{ cursor:pointer; }
    button:hover{ border-color:#555; }
    .hint{ font-size:12px; color:var(--muted); margin-top:6px; line-height:1.5; }

    main{ padding:10px; }

    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
    }
    .panelHead{
      padding:8px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--border);
    }
    .title{
      font-size:12px; color:#bbb; overflow:hidden;
      text-overflow:ellipsis; white-space:nowrap; max-width: 70%;
    }
    .actions{ display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }

    .thumbs{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(var(--thumb-min), 1fr));
      gap: var(--gap);
      padding:10px;
    }
    .thumb{
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background:#070707;
      transition: transform .05s ease-in-out;
    }
    .thumb:active{ transform: scale(0.99); }

    .thumbHead{
      padding:8px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      border-bottom:1px solid var(--border);
    }
    .thumbMeta{
      font-size:12px; color:#bbb;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      max-width: 70%;
    }
    .thumbActions{ display:flex; gap:6px; }

    .miniPlayer{
      position:relative;
      width:100%;
      aspect-ratio:16/9;
      background:#000;
    }
    iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; }

    .danger{ border-color:#5a2a2a; }
  </style>
</head>
<body>
<header>
  <div class="row">
    <input id="input" placeholder="ãƒãƒ£ãƒ³ãƒãƒ«ID(UC...) / ãƒãƒ£ãƒ³ãƒãƒ«URL / ãƒ©ã‚¤ãƒ–å‹•ç”»URL ã‚’è²¼ã£ã¦è¿½åŠ " />
    <button id="add">è¿½åŠ </button>
    <button id="clear" class="danger">å…¨éƒ¨å‰Šé™¤</button>

    <label style="display:flex;gap:6px;align-items:center;">
      ã‚µãƒ ãƒæœ€å°å¹…
      <select id="thumbMin">
        <option value="180">180</option>
        <option value="220" selected>220</option>
        <option value="280">280</option>
        <option value="360">360</option>
      </select>
    </label>

    <button id="exportJson">JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>

    <label style="display:flex;align-items:center;gap:6px;">
      JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ
      <input id="importJson" type="file" accept="application/json" style="display:none;">
    </label>
  </div>

  <div class="hint">
    ã‚µãƒ ãƒï¼ˆå‹•ç”»ã‚¿ã‚¤ãƒ«ï¼‰ã ã‘ã‚’ä¸€è¦§è¡¨ç¤ºã—ã¾ã™ã€‚iOSå¯¾ç­–ã§åŸ‹ã‚è¾¼ã¿ã¯å¸¸ã«ãƒŸãƒ¥ãƒ¼ãƒˆå›ºå®šã§ã™ï¼ˆéŸ³ã¯YouTubeã§é–‹ã„ã¦è¦–è´æ¨å¥¨ï¼‰ã€‚
  </div>
</header>

<main>
  <section class="panel">
    <div class="panelHead">
      <div class="title">ã‚µãƒ ãƒä¸€è¦§</div>
      <div class="actions">
        <button id="reloadEmbeds">å†èª­ã¿è¾¼ã¿</button>
        <button id="allMute">ï¼ˆè¨˜éŒ²ä¸Šï¼‰å…¨éƒ¨ãƒŸãƒ¥ãƒ¼ãƒˆ</button>
      </div>
    </div>
    <div class="thumbs" id="thumbs"></div>
  </section>
</main>

<script>
  const LS_KEY  = "yt_multi_live_items_v2";
  // äº’æ›ã®ãŸã‚æ®‹ã—ã¦ã‚‚è‰¯ã„ãŒã€ã“ã®UIã§ã¯ä½¿ã‚ãªã„
  const LS_MAIN = "yt_multi_live_main_idx_v2";

  function parseToEmbedUrl(text){
    const s = (text || "").trim();
    if (!s) return null;

    if (/^UC[a-zA-Z0-9_-]{10,}$/.test(s)) {
      return `https://www.youtube.com/embed/live_stream?channel=${encodeURIComponent(s)}&autoplay=0&mute=1`;
    }

    try{
      const u = new URL(s);

      if (u.hostname === "youtu.be"){
        const id = u.pathname.replace("/", "");
        if (id) return `https://www.youtube.com/embed/${encodeURIComponent(id)}?autoplay=0&mute=1`;
      }

      if (u.searchParams.get("v")){
        const id = u.searchParams.get("v");
        return `https://www.youtube.com/embed/${encodeURIComponent(id)}?autoplay=0&mute=1`;
      }

      const liveMatch = u.pathname.match(/^\/live\/([a-zA-Z0-9_-]+)/);
      if (liveMatch){
        const id = liveMatch[1];
        return `https://www.youtube.com/embed/${encodeURIComponent(id)}?autoplay=0&mute=1`;
      }

      const chMatch = u.pathname.match(/^\/channel\/(UC[a-zA-Z0-9_-]+)/);
      if (chMatch){
        const cid = chMatch[1];
        return `https://www.youtube.com/embed/live_stream?channel=${encodeURIComponent(cid)}&autoplay=0&mute=1`;
      }

      return null;
    }catch{
      return null;
    }
  }

  function loadItems(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }catch{ return []; }
  }
  function saveItems(items){
    localStorage.setItem(LS_KEY, JSON.stringify(items));
  }

  function makeIframe(src){
    const iframe = document.createElement("iframe");
    iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
    iframe.allowFullscreen = true;
    iframe.src = src;
    return iframe;
  }

  function setMuteOnEmbedUrl(embedUrl, mute){
    const u = new URL(embedUrl);
    u.searchParams.set("mute", mute ? "1" : "0");
    return u.toString();
  }

  function render(){
    const items = loadItems();
    const thumbs = document.getElementById("thumbs");
    thumbs.innerHTML = "";

    items.forEach((item, idx) => {
      const card = document.createElement("div");
      card.className = "thumb";

      const head = document.createElement("div");
      head.className = "thumbHead";

      const meta = document.createElement("div");
      meta.className = "thumbMeta";
      meta.textContent = item.label || item.raw;

      const actions = document.createElement("div");
      actions.className = "thumbActions";

      const openBtn = document.createElement("button");
      openBtn.textContent = "YouTubeã§é–‹ã";
      openBtn.onclick = (e) => {
        e.stopPropagation();
        window.open(item.openUrl, "_blank", "noopener,noreferrer");
      };

      // ã“ã®UIã§ã¯ã€ŒåŸ‹ã‚è¾¼ã¿ã¯å¸¸ã«ãƒŸãƒ¥ãƒ¼ãƒˆå›ºå®šã€ãªã®ã§ã€muteã¯"è¨˜éŒ²ç”¨ãƒˆã‚°ãƒ«"ã¨ã—ã¦æ®‹ã™
      // ï¼ˆå°†æ¥ãƒ¡ã‚¤ãƒ³å¾©æ´»ã‚„æŒ™å‹•å¤‰æ›´ã—ãŸããªã£ãŸæ™‚ã«äº’æ›æ€§ãŒåŠ¹ãï¼‰
      const muteBtn = document.createElement("button");
      muteBtn.textContent = item.mute ? "ğŸ”‡" : "ğŸ”Š";
      muteBtn.title = item.mute ? "ï¼ˆè¨˜éŒ²ä¸Šï¼‰ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤" : "ï¼ˆè¨˜éŒ²ä¸Šï¼‰ãƒŸãƒ¥ãƒ¼ãƒˆ";
      muteBtn.onclick = (e) => {
        e.stopPropagation();
        const items2 = loadItems();
        items2[idx].mute = !items2[idx].mute;
        saveItems(items2);
        render();
      };

      const delBtn = document.createElement("button");
      delBtn.textContent = "âœ•";
      delBtn.title = "å‰Šé™¤";
      delBtn.onclick = (e) => {
        e.stopPropagation();
        const items2 = loadItems();
        items2.splice(idx, 1);
        saveItems(items2);
        render();
      };

      actions.append(openBtn, muteBtn, delBtn);
      head.append(meta, actions);

      const mini = document.createElement("div");
      mini.className = "miniPlayer";
      // iOSå¯¾ç­–ï¼šåŸ‹ã‚è¾¼ã¿ã¯å¸¸ã«ãƒŸãƒ¥ãƒ¼ãƒˆå›ºå®š
      const thumbSrc = setMuteOnEmbedUrl(item.embedUrl, true);
      mini.appendChild(makeIframe(thumbSrc));

      card.append(head, mini);
      thumbs.appendChild(card);
    });
  }

  // ===== æ“ä½œ =====

  document.getElementById("add").onclick = () => {
    const raw = document.getElementById("input").value.trim();
    const embedUrl = parseToEmbedUrl(raw);
    if (!embedUrl){
      alert("è§£é‡ˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒãƒ£ãƒ³ãƒãƒ«ID(UC...)ã‹ã€ãƒ©ã‚¤ãƒ–/å‹•ç”»URLã‚’è²¼ã£ã¦ãã ã•ã„ã€‚");
      return;
    }

    let openUrl = raw;
    if (/^UC[a-zA-Z0-9_-]{10,}$/.test(raw)){
      openUrl = `https://www.youtube.com/channel/${raw}/live`;
    }

    const items = loadItems();
    items.push({
      raw,
      label: raw,
      embedUrl,
      openUrl,
      mute: true
    });
    saveItems(items);

    document.getElementById("input").value = "";
    render();
  };

  document.getElementById("clear").onclick = () => {
    localStorage.removeItem(LS_KEY);
    // ãƒ¡ã‚¤ãƒ³ã¯å»ƒæ­¢ã ãŒã€éå»äº’æ›ã®ãŸã‚æ®‹ã£ã¦ã¦ã‚‚å®³ã¯ãªã„
    // localStorage.removeItem(LS_MAIN);
    render();
  };

  document.getElementById("thumbMin").onchange = (e) => {
    document.documentElement.style.setProperty("--thumb-min", `${e.target.value}px`);
  };

  document.getElementById("reloadEmbeds").onclick = () => {
    render();
  };

  document.getElementById("allMute").onclick = () => {
    const items = loadItems();
    items.forEach(it => it.mute = true);
    saveItems(items);
    render();
  };

  // åˆæœŸ
  render();

  // ===== JSON Export / Importï¼ˆæ—¥æ™‚ä»˜ããƒ•ã‚¡ã‚¤ãƒ«å + å…±æœ‰å„ªå…ˆï¼‰ =====

  function pad2(n){ return String(n).padStart(2, "0"); }
  function formatTimestampLocal(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = pad2(d.getMonth() + 1);
    const dd = pad2(d.getDate());
    const hh = pad2(d.getHours());
    const mi = pad2(d.getMinutes());
    const ss = pad2(d.getSeconds());
    return `${yyyy}${mm}${dd}-${hh}${mi}${ss}`;
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
  }

  document.getElementById("exportJson").onclick = async () => {
    const data = {
      version: 1,
      exportedAt: new Date().toISOString(),
      items: loadItems(),
      // äº’æ›ã®ãŸã‚æ®‹ã™ï¼ˆã‚µãƒ ãƒã®ã¿UIã§ã¯ä½¿ã‚ãªã„ï¼‰
      mainIdx: 0
    };

    const jsonText = JSON.stringify(data, null, 2);
    const ts = formatTimestampLocal();
    const filename = `yt-multi-live_${ts}.json`;
    const blob = new Blob([jsonText], { type: "application/json" });

    // å…±æœ‰ï¼ˆiPad/iPhoneã§ä¿å­˜å…ˆã‚’é¸ã¹ã¦ä¸€ç•ªç¢ºå®Ÿï¼‰
    try {
      if (navigator.canShare && navigator.canShare({ files: [new File([blob], filename, { type: blob.type })] })) {
        const file = new File([blob], filename, { type: blob.type });
        await navigator.share({ files: [file], title: filename, text: "YouTube multi-live config JSON" });
        return;
      }
    } catch (e) {}

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // æœ€çµ‚ä¿é™ºï¼ˆå¿…è¦ãªã‚‰æœ‰åŠ¹åŒ–ï¼‰ï¼šæ–°è¦ã‚¿ãƒ–ã§JSONè¡¨ç¤ºâ†’å…±æœ‰ã§ä¿å­˜
    // const w = window.open();
    // if (w) w.document.write(`<pre>${escapeHtml(jsonText)}</pre>`);
  };

  document.getElementById("importJson").onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);

        if (!Array.isArray(data.items)) {
          throw new Error("items ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
        }

        const items = data.items.map(it => ({
          raw: it.raw || "",
          label: it.label || it.raw || "",
          embedUrl: it.embedUrl,
          openUrl: it.openUrl || it.raw,
          mute: !!it.mute
        })).filter(it => it.embedUrl);

        saveItems(items);
        render();

        alert("JSONã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ");
      } catch (err) {
        alert("JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:\n" + err.message);
      } finally {
        e.target.value = "";
      }
    };

    reader.readAsText(file);
  };
</script>
</body>
</html>