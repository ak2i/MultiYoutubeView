<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Multi YouTube Live Viewer (Main + Thumbs)</title>
  <style>
    :root{
      --gap: 10px;
      --thumb-min: 220px;
      --bg: #111;
      --panel: #0b0b0b;
      --border: #222;
      --text: #eee;
      --muted: #aaa;
    }
    body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",sans-serif; background:var(--bg); color:var(--text); }
    header{
      position: sticky; top:0; z-index:10;
      background:#161616; border-bottom:1px solid #2a2a2a;
      padding:10px;
    }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input, button, select{
      background:#0f0f0f; color:var(--text);
      border:1px solid #333; border-radius:10px;
      padding:10px;
    }
    input{ min-width:min(560px, 92vw); }
    button{ cursor:pointer; }
    button:hover{ border-color:#555; }
    .hint{ font-size:12px; color:var(--muted); margin-top:6px; line-height:1.5; }

    main{ padding:10px; }
    .layout{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      grid-template-rows: auto;
      gap: var(--gap);
      align-items: start;
    }
    /* iPhoneç¸¦ã ã¨ãƒ¡ã‚¤ãƒ³ã‚’ä¸Šã€ã‚µãƒ ãƒã‚’ä¸‹ */
    @media (max-width: 900px){
      .layout{ grid-template-columns: 1fr; }
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
    }

    .panelHead{
      padding:8px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--border);
    }
    .title{
      font-size:12px; color:#bbb; overflow:hidden;
      text-overflow:ellipsis; white-space:nowrap; max-width: 70%;
    }
    .actions{ display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }

    .player{
      position:relative;
      width:100%;
      aspect-ratio:16/9;
      background:#000;
    }
    iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; }

    .thumbs{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(var(--thumb-min), 1fr));
      gap: var(--gap);
      padding:10px;
    }
    .thumb{
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background:#070707;
      cursor:pointer;
      transition: transform .05s ease-in-out;
    }
    .thumb:active{ transform: scale(0.99); }
    .thumb.selected{ outline: 2px solid #6aa6ff; }

    .thumbHead{
      padding:8px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      border-bottom:1px solid var(--border);
    }
    .thumbMeta{
      font-size:12px; color:#bbb;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      max-width: 70%;
    }
    .thumbActions{ display:flex; gap:6px; }
    .miniPlayer{
      position:relative;
      width:100%;
      aspect-ratio:16/9;
      background:#000;
    }

    .danger{ border-color:#5a2a2a; }
  </style>
</head>
<body>
<header>
  <div class="row">
    <input id="input" placeholder="ãƒãƒ£ãƒ³ãƒãƒ«ID(UC...) / ãƒãƒ£ãƒ³ãƒãƒ«URL / ãƒ©ã‚¤ãƒ–å‹•ç”»URL ã‚’è²¼ã£ã¦è¿½åŠ " />
    <button id="add">è¿½åŠ </button>
    <button id="clear" class="danger">å…¨éƒ¨å‰Šé™¤</button>

    <label style="display:flex;gap:6px;align-items:center;">
      ã‚µãƒ ãƒæœ€å°å¹…
      <select id="thumbMin">
        <option value="180">180</option>
        <option value="220" selected>220</option>
        <option value="280">280</option>
        <option value="360">360</option>
      </select>
    </label>
  </div>
  <div class="hint">
    ã‚¿ãƒƒãƒ—ã§ãƒ¡ã‚¤ãƒ³åˆ‡æ›¿ã€‚iPhoneã¯åŒæ™‚å†ç”Ÿ/è‡ªå‹•å†ç”ŸãŒåˆ¶é™ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãšã¯ã€Œãƒ¡ã‚¤ãƒ³ã ã‘ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤ã€ãŒå®‰å®šã§ã™ã€‚
  </div>
</header>

<main>
  <div class="layout">
    <!-- Main -->
    <section class="panel" id="mainPanel">
      <div class="panelHead">
        <div class="title" id="mainTitle">ãƒ¡ã‚¤ãƒ³</div>
        <div class="actions">
          <button id="mainUnmute">ãƒ¡ã‚¤ãƒ³ã ã‘ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤</button>
          <button id="allMute">å…¨éƒ¨ãƒŸãƒ¥ãƒ¼ãƒˆ</button>
          <button id="openMain">YouTubeã§é–‹ã</button>
        </div>
      </div>
      <div class="player" id="mainPlayer"></div>
    </section>

    <!-- Thumbs -->
    <section class="panel">
      <div class="panelHead">
        <div class="title">ã‚µãƒ ãƒä¸€è¦§ï¼ˆã‚¿ãƒƒãƒ—ã§ãƒ¡ã‚¤ãƒ³ã¸ï¼‰</div>
        <div class="actions">
          <button id="reloadEmbeds">å†èª­ã¿è¾¼ã¿</button>
        </div>
      </div>
      <div class="thumbs" id="thumbs"></div>
    </section>
  </div>
</main>

<script>
  const LS_KEY = "yt_multi_live_items_v2";
  const LS_MAIN = "yt_multi_live_main_idx_v2";

  function parseToEmbedUrl(text){
    const s = (text || "").trim();
    if (!s) return null;

    if (/^UC[a-zA-Z0-9_-]{10,}$/.test(s)) {
      return `https://www.youtube.com/embed/live_stream?channel=${encodeURIComponent(s)}&autoplay=0&mute=1`;
    }

    try{
      const u = new URL(s);

      if (u.hostname === "youtu.be"){
        const id = u.pathname.replace("/", "");
        if (id) return `https://www.youtube.com/embed/${encodeURIComponent(id)}?autoplay=0&mute=1`;
      }

      if (u.searchParams.get("v")){
        const id = u.searchParams.get("v");
        return `https://www.youtube.com/embed/${encodeURIComponent(id)}?autoplay=0&mute=1`;
      }

      const liveMatch = u.pathname.match(/^\/live\/([a-zA-Z0-9_-]+)/);
      if (liveMatch){
        const id = liveMatch[1];
        return `https://www.youtube.com/embed/${encodeURIComponent(id)}?autoplay=0&mute=1`;
      }

      const chMatch = u.pathname.match(/^\/channel\/(UC[a-zA-Z0-9_-]+)/);
      if (chMatch){
        const cid = chMatch[1];
        return `https://www.youtube.com/embed/live_stream?channel=${encodeURIComponent(cid)}&autoplay=0&mute=1`;
      }

      return null;
    }catch{
      return null;
    }
  }

  function loadItems(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }catch{ return []; }
  }
  function saveItems(items){
    localStorage.setItem(LS_KEY, JSON.stringify(items));
  }
  function loadMainIdx(){
    const n = Number(localStorage.getItem(LS_MAIN) || "0");
    return Number.isFinite(n) ? n : 0;
  }
  function saveMainIdx(i){
    localStorage.setItem(LS_MAIN, String(i));
  }

  function makeIframe(src){
    const iframe = document.createElement("iframe");
    iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
    iframe.allowFullscreen = true;
    iframe.src = src;
    return iframe;
  }

  function setMuteOnEmbedUrl(embedUrl, mute){
    const u = new URL(embedUrl);
    u.searchParams.set("mute", mute ? "1" : "0");
    return u.toString();
  }

  function render(){
    const items = loadItems();
    let mainIdx = loadMainIdx();
    if (mainIdx < 0) mainIdx = 0;
    if (mainIdx >= items.length) mainIdx = 0;

    // Main
    const mainTitle = document.getElementById("mainTitle");
    const mainPlayer = document.getElementById("mainPlayer");
    const openMain = document.getElementById("openMain");

    mainPlayer.innerHTML = "";

    if (items.length === 0){
      mainTitle.textContent = "ãƒ¡ã‚¤ãƒ³ï¼ˆã¾ã ä½•ã‚‚ã‚ã‚Šã¾ã›ã‚“ï¼‰";
      openMain.onclick = () => {};
    } else {
      const main = items[mainIdx];
      mainTitle.textContent = main.label || main.raw;
      openMain.onclick = () => window.open(main.openUrl, "_blank", "noopener,noreferrer");

      const src = setMuteOnEmbedUrl(main.embedUrl, !!main.mute);
      mainPlayer.appendChild(makeIframe(src));
    }

    // Thumbs
    const thumbs = document.getElementById("thumbs");
    thumbs.innerHTML = "";

    items.forEach((item, idx) => {
      const card = document.createElement("div");
      card.className = "thumb" + (idx === mainIdx ? " selected" : "");
      card.onclick = (e) => {
        // ãƒœã‚¿ãƒ³æ“ä½œæ™‚ã¯åˆ‡æ›¿ã—ãªã„
        if (e.target && (e.target.tagName === "BUTTON")) return;
        saveMainIdx(idx);
        render();
      };

      const head = document.createElement("div");
      head.className = "thumbHead";

      const meta = document.createElement("div");
      meta.className = "thumbMeta";
      meta.textContent = item.label || item.raw;

      const actions = document.createElement("div");
      actions.className = "thumbActions";

      const muteBtn = document.createElement("button");
      muteBtn.textContent = item.mute ? "ğŸ”‡" : "ğŸ”Š";
      muteBtn.title = item.mute ? "ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤" : "ãƒŸãƒ¥ãƒ¼ãƒˆ";
      muteBtn.onclick = (e) => {
        e.stopPropagation();
        const items2 = loadItems();
        items2[idx].mute = !items2[idx].mute;
        saveItems(items2);
        render();
      };

      const delBtn = document.createElement("button");
      delBtn.textContent = "âœ•";
      delBtn.title = "å‰Šé™¤";
      delBtn.onclick = (e) => {
        e.stopPropagation();
        const items2 = loadItems();
        items2.splice(idx, 1);
        saveItems(items2);
        const mi = loadMainIdx();
        if (idx === mi) saveMainIdx(0);
        else if (idx < mi) saveMainIdx(Math.max(0, mi - 1));
        render();
      };

      actions.append(muteBtn, delBtn);
      head.append(meta, actions);

      const mini = document.createElement("div");
      mini.className = "miniPlayer";
      // ã‚µãƒ ãƒå´ã¯åŸå‰‡ãƒŸãƒ¥ãƒ¼ãƒˆã§å›ºå®šï¼ˆiOSå¯¾ç­–ï¼šéŸ³ãŒé³´ã‚Šã¾ãã‚‹ã®ã‚’é˜²ãï¼‰
      const thumbSrc = setMuteOnEmbedUrl(item.embedUrl, true);
      mini.appendChild(makeIframe(thumbSrc));

      card.append(head, mini);
      thumbs.appendChild(card);
    });
  }

  document.getElementById("add").onclick = () => {
    const raw = document.getElementById("input").value.trim();
    const embedUrl = parseToEmbedUrl(raw);
    if (!embedUrl){
      alert("è§£é‡ˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒãƒ£ãƒ³ãƒãƒ«ID(UC...)ã‹ã€ãƒ©ã‚¤ãƒ–/å‹•ç”»URLã‚’è²¼ã£ã¦ãã ã•ã„ã€‚");
      return;
    }

    let openUrl = raw;
    if (/^UC[a-zA-Z0-9_-]{10,}$/.test(raw)){
      openUrl = `https://www.youtube.com/channel/${raw}/live`;
    }

    const items = loadItems();
    items.push({
      raw,
      label: raw,
      embedUrl,
      openUrl,
      mute: true
    });
    saveItems(items);

    // æœ€åˆã®è¿½åŠ ãªã‚‰ãƒ¡ã‚¤ãƒ³ã«
    if (items.length === 1) saveMainIdx(0);

    document.getElementById("input").value = "";
    render();
  };

  document.getElementById("clear").onclick = () => {
    localStorage.removeItem(LS_KEY);
    localStorage.removeItem(LS_MAIN);
    render();
  };

  document.getElementById("thumbMin").onchange = (e) => {
    document.documentElement.style.setProperty("--thumb-min", `${e.target.value}px`);
  };

  document.getElementById("mainUnmute").onclick = () => {
    const items = loadItems();
    const mainIdx = loadMainIdx();
    items.forEach((it, idx) => { it.mute = idx !== mainIdx; });
    saveItems(items);
    render();
  };

  document.getElementById("allMute").onclick = () => {
    const items = loadItems();
    items.forEach(it => it.mute = true);
    saveItems(items);
    render();
  };

  document.getElementById("reloadEmbeds").onclick = () => {
    // iOSã‚„å›ç·šçŠ¶æ³ã§åŸ‹ã‚è¾¼ã¿ãŒå›ºã¾ã£ãŸæ™‚ã®æ‰‹å‹•ãƒªãƒ­ãƒ¼ãƒ‰ç”¨
    render();
  };

  // åˆæœŸ
  render();
  
  // ===== JSON Export / Import =====

document.getElementById("exportJson").onclick = () => {
  const data = {
    version: 1,
    exportedAt: new Date().toISOString(),
    items: loadItems(),
    mainIdx: loadMainIdx()
  };

  const blob = new Blob(
    [JSON.stringify(data, null, 2)],
    { type: "application/json" }
  );

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "yt-multi-live.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};

document.getElementById("importJson").onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);

      // æœ€ä½é™ã®æ§‹é€ ãƒã‚§ãƒƒã‚¯
      if (!Array.isArray(data.items)) {
        throw new Error("items ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
      }

      // æƒ³å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ­£è¦åŒ–
      const items = data.items.map(it => ({
        raw: it.raw || "",
        label: it.label || it.raw || "",
        embedUrl: it.embedUrl,
        openUrl: it.openUrl || it.raw,
        mute: !!it.mute
      })).filter(it => it.embedUrl);

      const mainIdx =
        Number.isInteger(data.mainIdx) && data.mainIdx >= 0
          ? Math.min(data.mainIdx, items.length - 1)
          : 0;

      saveItems(items);
      saveMainIdx(mainIdx);
      render();

      alert("JSONã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ");
    } catch (err) {
      alert("JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:\n" + err.message);
    } finally {
      e.target.value = ""; // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠã§ãã‚‹ã‚ˆã†ã«
    }
  };

  reader.readAsText(file);
};
</script>
</body>
</html>