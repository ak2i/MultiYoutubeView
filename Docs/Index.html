<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Multi YouTube Live Viewer</title>
  <style>
    :root { --gap: 10px; --tile-min: 360px; }
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; background:#111; color:#eee; }
    header { position: sticky; top: 0; background: #161616; border-bottom: 1px solid #2a2a2a; padding: 10px; z-index: 10; }
    .row { display:flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input, button, select {
      background:#0f0f0f; color:#eee; border:1px solid #333; border-radius: 8px; padding: 10px;
    }
    input { min-width: min(560px, 92vw); }
    button { cursor:pointer; }
    button:hover { border-color:#555; }
    main { padding: 10px; }
    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(var(--tile-min), 1fr));
      gap: var(--gap);
    }
    .tile { background:#0b0b0b; border:1px solid #222; border-radius: 12px; overflow:hidden; }
    .tile header {
      position: static; background: transparent; border: 0; padding: 8px 10px; display:flex; gap: 8px; align-items:center; justify-content: space-between;
    }
    .tile .meta { font-size: 12px; color:#bbb; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 70%; }
    .tile .actions { display:flex; gap: 6px; }
    .player {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background:#000;
    }
    iframe { position:absolute; inset:0; width:100%; height:100%; border:0; }
    .hint { font-size: 12px; color:#aaa; margin-top: 6px; line-height: 1.5; }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <input id="input" placeholder="チャンネルID(UC...) / チャンネルURL / ライブ動画URL を貼って追加" />
      <button id="add">追加</button>
      <button id="clear">全部削除</button>

      <label style="display:flex;gap:6px;align-items:center;">
        列最小幅
        <select id="tileMin">
          <option value="300">300</option>
          <option value="360" selected>360</option>
          <option value="420">420</option>
          <option value="520">520</option>
        </select>
      </label>
    </div>
    <div class="hint">
      使い方：複数貼って「追加」→ タイル表示。音が邪魔なら各タイルの「ミュート」推奨。<br/>
      注意：ブラウザの自動再生制限により、最初は停止/ミュートになることがあります。
    </div>
  </header>

  <main>
    <div id="grid" class="grid"></div>
  </main>

<script>
  const LS_KEY = "yt_multi_live_items_v1";

  // 1) 入力から「ライブ埋め込みURL」を作る
  function parseToEmbedUrl(text) {
    const s = (text || "").trim();
    if (!s) return null;

    // チャンネルID（UC...）っぽい
    if (/^UC[a-zA-Z0-9_-]{10,}$/.test(s)) {
      return `https://www.youtube.com/embed/live_stream?channel=${encodeURIComponent(s)}&autoplay=0&mute=1`;
    }

    // URLの場合
    try {
      const u = new URL(s);

      // youtu.be/<id>
      if (u.hostname === "youtu.be") {
        const id = u.pathname.replace("/", "");
        if (id) return `https://www.youtube.com/embed/${encodeURIComponent(id)}?autoplay=0&mute=1`;
      }

      // youtube.com/watch?v=<id>
      if (u.searchParams.get("v")) {
        const id = u.searchParams.get("v");
        return `https://www.youtube.com/embed/${encodeURIComponent(id)}?autoplay=0&mute=1`;
      }

      // youtube.com/live/<id>
      const liveMatch = u.pathname.match(/^\/live\/([a-zA-Z0-9_-]+)/);
      if (liveMatch) {
        const id = liveMatch[1];
        return `https://www.youtube.com/embed/${encodeURIComponent(id)}?autoplay=0&mute=1`;
      }

      // youtube.com/@handle や /channel/<id> など
      const chMatch = u.pathname.match(/^\/channel\/(UC[a-zA-Z0-9_-]+)/);
      if (chMatch) {
        const cid = chMatch[1];
        return `https://www.youtube.com/embed/live_stream?channel=${encodeURIComponent(cid)}&autoplay=0&mute=1`;
      }

      // それ以外はそのまま扱えない（ハンドルからチャンネルID解決はAPIが要る）
      return null;
    } catch {
      // URLでもIDでもない
      return null;
    }
  }

  function loadItems() {
    try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
    catch { return []; }
  }
  function saveItems(items) {
    localStorage.setItem(LS_KEY, JSON.stringify(items));
  }

  function render() {
    const grid = document.getElementById("grid");
    const items = loadItems();
    grid.innerHTML = "";

    items.forEach((item, idx) => {
      const tile = document.createElement("div");
      tile.className = "tile";

      const h = document.createElement("header");
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = item.label || item.raw;

      const actions = document.createElement("div");
      actions.className = "actions";

      const muteBtn = document.createElement("button");
      muteBtn.textContent = item.mute ? "ミュート解除" : "ミュート";
      muteBtn.onclick = () => {
        item.mute = !item.mute;
        // iframeのURLを更新して反映
        const items2 = loadItems();
        items2[idx].mute = item.mute;
        saveItems(items2);
        render();
      };

      const openBtn = document.createElement("button");
      openBtn.textContent = "YouTubeで開く";
      openBtn.onclick = () => window.open(item.openUrl, "_blank", "noopener,noreferrer");

      const delBtn = document.createElement("button");
      delBtn.textContent = "削除";
      delBtn.onclick = () => {
        const items2 = loadItems();
        items2.splice(idx, 1);
        saveItems(items2);
        render();
      };

      actions.append(muteBtn, openBtn, delBtn);
      h.append(meta, actions);

      const player = document.createElement("div");
      player.className = "player";

      const iframe = document.createElement("iframe");
      iframe.allow =
        "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
      iframe.allowFullscreen = true;

      // muteは埋め込みURLのクエリで付け替え（簡易版）
      const url = new URL(item.embedUrl);
      url.searchParams.set("mute", item.mute ? "1" : "0");
      iframe.src = url.toString();

      player.appendChild(iframe);

      tile.append(h, player);
      grid.appendChild(tile);
    });
  }

  document.getElementById("add").onclick = () => {
    const raw = document.getElementById("input").value.trim();
    const embedUrl = parseToEmbedUrl(raw);
    if (!embedUrl) {
      alert("解釈できませんでした。チャンネルID(UC...)か、ライブ/動画URLを貼ってください。");
      return;
    }

    // YouTubeで開く用URL（動画IDなら watch、チャンネルIDなら channel）
    let openUrl = raw;
    if (/^UC[a-zA-Z0-9_-]{10,}$/.test(raw)) {
      openUrl = `https://www.youtube.com/channel/${raw}/live`;
    }

    const items = loadItems();
    items.push({
      raw,
      label: raw,
      embedUrl,
      openUrl,
      mute: true,
    });
    saveItems(items);

    document.getElementById("input").value = "";
    render();
  };

  document.getElementById("clear").onclick = () => {
    localStorage.removeItem(LS_KEY);
    render();
  };

  document.getElementById("tileMin").onchange = (e) => {
    document.documentElement.style.setProperty("--tile-min", `${e.target.value}px`);
  };

  // 初期
  render();
</script>
</body>
</html>
